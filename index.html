<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Litmus Tile Defense â€” Quiz & Difficulty</title>
  <style>
    :root {
      --bg:#f5f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --accent:#4f46e5;
      --red:#ef4444; --blue:#3b82f6; --neutral:#d1d5db;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; }
    .wrap { max-width: 1080px; margin: 24px auto; padding: 16px; }
    .card { background: var(--card); border-radius: 18px; box-shadow: 0 10px 30px rgba(2,6,23,.08); padding: 18px; }
    h1 { margin: 0 0 8px 0; font-size: 28px; letter-spacing: -0.01em; }
    .lead { color: var(--muted); margin: 0 0 12px 0; }
    .row { display: grid; grid-template-columns: 1fr; gap: 14px; }
    .toolbar { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: start; }
    .shelf {
      display: grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:10px;
      background:#f8fafc; border:1px dashed #e2e8f0; padding:10px; border-radius:12px;
    }
    @media (max-width: 960px){ .shelf{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    .item {
      border:1px solid #e2e8f0; border-radius:12px; background:white; padding:8px; cursor:pointer; text-align:center;
      display:flex; flex-direction:column; gap:6px; justify-content:center; align-items:center; min-height:84px;
    }
    .item .emoji { font-size: 22px; }
    .item .name { font-weight:700; font-size:13px; }
    .item .tag { font-size:12px; color:#64748b; }
    .item.selected { outline:2px solid var(--accent); }
    .controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    button { border:0; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; background:#e2e8f0; color:#0f172a; }
    button.primary { background: var(--accent); color: white; }
    button.ghost { background: transparent; border: 1px solid #e2e8f0; }
    button[disabled]{ opacity:.5; cursor:not-allowed; }
    .stats { display:flex; gap:14px; flex-wrap:wrap; font-size:14px; color:var(--muted); }
    .stat b { color:var(--ink); }
    canvas { background: white; border-radius: 12px; border: 1px solid #e5e7eb; display:block; width:100%; height:auto; touch-action: none; }
    .legend { display:flex; gap:10px; align-items:center; color:var(--muted); font-size:13px; }
    .dot { width:14px; height:14px; border-radius:4px; border:1px solid #e5e7eb; }
    .notice { background:#eef2ff; border:1px solid #c7d2fe; color:#3730a3; padding:10px 14px; border-radius:12px; }
    .footer { margin-top: 14px; color: var(--muted); font-size: 12px; }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid #e2e8f0; color:#64748b; background:#f8fafc; }
    /* Quiz modal */
    .modal {
      position: fixed; inset: 0; display:none; place-items:center; background: rgba(15,23,42,0.45);
      z-index: 50;
    }
    .modal .box {
      width: min(720px, 92vw); background: white; border-radius: 16px; padding: 18px;
      box-shadow: 0 20px 50px rgba(2,6,23,.25);
    }
    .quiz-list { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:8px; }
    @media (max-width: 720px){ .quiz-list{ grid-template-columns: 1fr; } }
    .quiz-item { border:1px solid #e5e7eb; border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:6px; cursor:pointer; }
    .quiz-item .big { font-size: 28px; }
    .quiz-footer { display:flex; justify-content:space-between; align-items:center; margin-top:10px; font-size:13px; color:#64748b; }
    .hint { font-size:12px; color:#64748b; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Litmus Tile Defense â€” Quiz & Difficulty</h1>
      <p class="lead">ì•„ì´í…œ(ë ˆëª¬, ì‹ì´ˆ, ë² ì´í‚¹ì†Œë‹¤, ì¦ë¥˜ìˆ˜ ë“±)ì„ ì„ íƒí•´ íƒ€ì¼ì„ í´ë¦­/í„°ì¹˜ë¡œ ìƒ‰ì„ ë°”ê¾¸ì„¸ìš”. ê²Œì„ ì‹œì‘ ì „ <b>ë¯¸ë‹ˆ í€´ì¦ˆ</b>ë¥¼ ë§ì¶”ë©´ ë³´ë„ˆìŠ¤ë¥¼ ë°›ìŠµë‹ˆë‹¤.</p>

      <div class="row">
        <div class="notice">
          <b>í•™ìŠµ í¬ì¸íŠ¸</b> Â· ì‚°ì„±(ë¹¨ê°„) ì˜ˆ: ë ˆëª¬ğŸ‹, ì‹ì´ˆğŸ§‰, íƒ„ì‚°ìŒë£ŒğŸ¥¤ Â· ì—¼ê¸°ì„±(íŒŒë€) ì˜ˆ: ë² ì´í‚¹ì†Œë‹¤ğŸ¥£, ë¹„ëˆ„ğŸ§¼, ì„¸ì œğŸ§´ Â· ì¤‘ì„±(íšŒìƒ‰) ì˜ˆ: ì¦ë¥˜ìˆ˜ğŸ’§, ì†Œê¸ˆë¬¼ğŸ§‚<br>
          <span class="pill">í™•ì¥ ê·œì¹™</span> í€´ì¦ˆ ë³´ë„ˆìŠ¤ Â· í˜¼í•© ì˜¤ì—¼(ê°„í˜¹ ë¹¨ê°„ ì˜¤ì—¼) Â· ì‹œê°„ ê²½ê³¼ ì‹œ ì˜¤ì—¼ ê°€ì† Â· ì¤‘ì„± ë³€í™˜ ì¶”ê°€ ë³´ë„ˆìŠ¤
        </div>

        <div class="toolbar">
          <div class="shelf" id="shelf"></div>
          <div class="controls">
            <button id="btn-start" class="primary">ì‹œì‘</button>
            <button id="btn-reset" class="ghost">ë¦¬ì…‹</button>
          </div>
        </div>

        <div class="stats">
          <div class="stat">ì„ íƒ: <b id="selName">-</b> <span class="pill" id="selTag">-</span></div>
          <div class="stat">ì‹œê°„: <b id="time">60.0</b>s</div>
          <div class="stat">ì ìˆ˜: <b id="score">0</b></div>
          <div class="stat">íŒŒë€ ë¹„ìœ¨: <b id="blueRatio">0%</b></div>
          <div class="legend">
            <span class="dot" style="background:#ef4444"></span> ì‚°ì„±
            <span class="dot" style="background:#3b82f6"></span> ì—¼ê¸°ì„±
            <span class="dot" style="background:#d1d5db"></span> ì¤‘ì„±
          </div>
        </div>

        <canvas id="game" width="1024" height="600" aria-label="litmus tile defense canvas"></canvas>

        <div class="footer">Â© HTML5 Canvas Demo â€” ì •ì  íŒŒì¼ í•˜ë‚˜ë¡œ ì‹¤í–‰</div>
      </div>
    </div>
  </div>

  <!-- Quiz Modal -->
  <div id="quizModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="quizTitle">
    <div class="box">
      <h2 id="quizTitle" style="margin:0 0 6px 0;">í€´ì¦ˆ: ë‹¤ìŒ ì¤‘ <u>ì‚°ì„±</u>ì¸ ê²ƒì€?</h2>
      <div class="hint">ì •ë‹µì„ ë§íˆë©´ ì‹œì‘ ë³´ë„ˆìŠ¤(ì ìˆ˜ +10 & ì´ˆê¸° ì˜¤ì—¼ 5ì¹¸ ì •í™”)ë¥¼ ë“œë¦½ë‹ˆë‹¤.</div>
      <div id="quizList" class="quiz-list"></div>
      <div class="quiz-footer">
        <span id="quizMsg">ë³´ê¸° ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</span>
        <button id="quizSkip" class="ghost">ê±´ë„ˆë›°ê¸°</button>
      </div>
    </div>
  </div>

<script>
(() => {
// ====== ì•„ì´í…œ(ì‹¤ìƒí™œ ë¬¼ì§ˆ) ëª©ë¡ ======
const ITEMS = [
  { name:"ë ˆëª¬ì¦™", tag:"ì‚°ì„±", kind:"acid", emoji:"ğŸ‹", hint:"êµ¬ì—°ì‚° í¬í•¨, ì•½ì‚°ì„±" },
  { name:"ì‹ì´ˆ", tag:"ì‚°ì„±", kind:"acid", emoji:"ğŸ§‰", hint:"ì•„ì„¸íŠ¸ì‚°, ì•½ì‚°ì„±" },
  { name:"íƒ„ì‚°ìŒë£Œ", tag:"ì‚°ì„±", kind:"acid", emoji:"ğŸ¥¤", hint:"íƒ„ì‚°(Hâ‚‚COâ‚ƒ), ì•½ì‚°ì„±" },
  { name:"ë² ì´í‚¹ì†Œë‹¤", tag:"ì—¼ê¸°ì„±", kind:"base", emoji:"ğŸ¥£", hint:"íƒ„ì‚°ìˆ˜ì†Œë‚˜íŠ¸ë¥¨, ì•½ì—¼ê¸°" },
  { name:"ë¹„ëˆ„ë¬¼", tag:"ì—¼ê¸°ì„±", kind:"base", emoji:"ğŸ§¼", hint:"ì§€ë°©ì‚°ì—¼, ì—¼ê¸°ì„± ì„¸ì •ì•¡" },
  { name:"ì„¸ì œ ìš©ì•¡", tag:"ì—¼ê¸°ì„±", kind:"base", emoji:"ğŸ§´", hint:"ê³„ë©´í™œì„±ì œ, ì—¼ê¸°ì„±" },
  { name:"ì¦ë¥˜ìˆ˜", tag:"ì¤‘ì„±", kind:"neutral", emoji:"ğŸ’§", hint:"ì´ì˜¨ ì ìŒ, ì¤‘ì„±" },
  { name:"ì†Œê¸ˆë¬¼", tag:"ì¤‘ì„±", kind:"neutral", emoji:"ğŸ§‚", hint:"NaCl ìˆ˜ìš©ì•¡, ì¤‘ì„±ì— ê°€ê¹Œì›€" },
  { name:"ìš°ìœ ", tag:"ì•½ì‚°ì„±", kind:"acid", emoji:"ğŸ¥›", hint:"ì –ì‚°Â·ë‹¨ë°±ì§ˆë¡œ ì•½ì‚°ì„±" },
];

// ====== ì„¤ì •ê°’ ======
const CFG = {
  cols: 12, rows: 8,
  baseTick: 800,             // ê¸°ë³¸ ì˜¤ì—¼ ì£¼ê¸°(ms)
  gameTime: 60,              // ì œí•œì‹œê°„(sec)
  baseSpread: 1,             // ê¸°ë³¸ ì˜¤ì—¼ ì¹¸ ìˆ˜
  redChance: 0.25,           // í˜¼í•© ì˜¤ì—¼: ë¹¨ê°„ ì˜¤ì—¼ í™•ë¥ 
  neutralBonus: 3,           // ì¤‘ì„± ë³€í™˜ ì¶”ê°€ ë³´ë„ˆìŠ¤
  quizCleanse: 5,            // í€´ì¦ˆ ë³´ë„ˆìŠ¤: ì •í™” ì¹¸ ìˆ˜
  quizScoreBonus: 10,        // í€´ì¦ˆ ë³´ë„ˆìŠ¤ ì ìˆ˜
};

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const STATE = {
  board: [], running:false, timeLeft:CFG.gameTime, score:0, combo:0,
  selected: null, timerId:null, spreadId:null, startEpoch: null
};

function el(id){ return document.getElementById(id); }

// ì„ ë°˜
function renderShelf(){
  const shelf = el('shelf');
  shelf.innerHTML = "";
  ITEMS.forEach((it, idx)=>{
    const div = document.createElement('button');
    div.type = "button";
    div.className = "item";
    div.setAttribute('data-idx', idx);
    div.innerHTML = `<div class="emoji">${it.emoji}</div>
                     <div class="name">${it.name}</div>
                     <div class="tag">${it.tag}</div>`;
    div.title = it.hint;
    div.addEventListener('click', () => selectItem(idx));
    shelf.appendChild(div);
  });
}

function selectItem(i){
  const it = ITEMS[i];
  STATE.selected = it;
  document.querySelectorAll('.item').forEach(el=> el.classList.remove('selected'));
  const btn = document.querySelector(`.item[data-idx="${i}"]`);
  if (btn) btn.classList.add('selected');
  el('selName').textContent = it.name;
  el('selTag').textContent = it.tag;
  el('selTag').style.borderColor = it.kind==='acid' ? '#fecaca' : it.kind==='base' ? '#bfdbfe' : '#e5e7eb';
  el('selTag').style.background  = it.kind==='acid' ? '#fef2f2' : it.kind==='base' ? '#eff6ff' : '#f8fafc';
}

function fitCanvas(){
  const rect = canvas.getBoundingClientRect();
  const ratio = window.devicePixelRatio || 1;
  canvas.width = Math.round(rect.width * ratio);
  canvas.height = Math.round(rect.width * (CFG.rows/CFG.cols) * ratio);
  draw();
}
new ResizeObserver(fitCanvas).observe(canvas);

// ë³´ë“œ
function idx(c,r){ return r*CFG.cols + c; }
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function initBoard(){
  STATE.board = new Array(CFG.rows*CFG.cols).fill('neutral');
  for (let i=0;i<CFG.cols;i++){ const r = randInt(0, CFG.rows-1); STATE.board[idx(i,r)]='blue'; }
}
function draw(){
  const w=canvas.width, h=canvas.height;
  const cellW=Math.floor(w/CFG.cols), cellH=Math.floor(h/CFG.rows);
  ctx.clearRect(0,0,w,h);
  for(let r=0;r<CFG.rows;r++){
    for(let c=0;c<CFG.cols;c++){
      const i=idx(c,r), v=STATE.board[i];
      ctx.fillStyle = v==='red' ? '#ef4444' : v==='blue' ? '#3b82f6' : '#d1d5db';
      ctx.fillRect(c*cellW, r*cellH, cellW, cellH);
      ctx.strokeStyle = '#e5e7eb'; ctx.strokeRect(c*cellW+0.5, r*cellH+0.5, cellW-1, cellH-1);
    }
  }
}

// ì¢Œí‘œâ†’ì…€
function getCellFromXY(x,y){
  const rect = canvas.getBoundingClientRect();
  const c = Math.floor(( (x-rect.left)/rect.width ) * CFG.cols);
  const r = Math.floor(( (y-rect.top) /rect.height) * CFG.rows);
  if(c<0||c>=CFG.cols||r<0||r>=CFG.rows) return null;
  return {c,r};
}

// ì ìš© ê·œì¹™ + ì¤‘ì„± ë³´ë„ˆìŠ¤
function applySelectedToCell(c,r){
  if(!STATE.selected) return;
  const kind = STATE.selected.kind; // 'acid'|'base'|'neutral'
  const i=idx(c,r); const cur=STATE.board[i];
  let changed=false, bonus=0;
  if(kind==='acid'){ changed = (cur!=='red'); STATE.board[i]='red'; }
  else if(kind==='base'){ changed = (cur!=='blue'); STATE.board[i]='blue'; }
  else { // neutral
    changed = (cur!=='neutral'); 
    if (cur!=='neutral') bonus += CFG.neutralBonus; 
    STATE.board[i]='neutral';
  }
  if(changed){ STATE.combo=(STATE.combo||0)+1; STATE.score += 1 + Math.max(0, STATE.combo-1)*2 + bonus; }
  else { STATE.combo=0; }
  updateStats(); draw();
}

// ë‚œì´ë„ ê³¡ì„ : ê²½ê³¼ ì‹œê°„ì— ë”°ë¼ ì˜¤ì—¼ ê°•ë„â†‘
function currentSpreadCount(){
  const elapsed = (Date.now() - STATE.startEpoch) / 1000; // sec
  const phase = Math.floor(elapsed / 15); // 0,1,2,3...
  return Math.min(1 + phase, 4); // 15ì´ˆë§ˆë‹¤ +1, ìµœëŒ€ 4ì¹¸
}
function currentTickMs(){
  const elapsed = (Date.now() - STATE.startEpoch) / 1000;
  const factor = 1 - Math.min(elapsed / CFG.gameTime, 0.9) * 0.5; // ìµœëŒ€ 50% ë¹¨ë¼ì§
  return Math.max(250, Math.floor(CFG.baseTick * factor));
}

function spreadOnce(){
  const k = currentSpreadCount();
  for(let t=0;t<k;t++){
    const i=randInt(0, STATE.board.length-1);
    // í˜¼í•© ì˜¤ì—¼: ì¼ì • í™•ë¥ ë¡œ ë¹¨ê°„ ì˜¤ì—¼
    const red = Math.random() < CFG.redChance;
    STATE.board[i] = red ? 'red' : 'blue';
  }
  draw(); checkWinLose();
}

function armSpreadTimer(){
  clearInterval(STATE.spreadId);
  STATE.spreadId = setInterval(()=>{
    spreadOnce();
    // ì£¼ê¸° ê°€ë³€: ë‹¤ìŒ í‹±ì— ë§ì¶° ì¬ì„¤ì •
    armSpreadTimer();
  }, currentTickMs());
}

function updateStats(){
  const blueCount = STATE.board.filter(v=>v==='blue').length;
  const ratio = blueCount / STATE.board.length;
  el('blueRatio').textContent = Math.round(ratio*100)+'%';
  el('score').textContent = STATE.score;
}
function checkWinLose(){
  const blueCount = STATE.board.filter(v=>v==='blue').length;
  const ratio = blueCount / STATE.board.length;
  if(ratio>=0.8) return endGame(false, "íŒŒë€ ë¹„ìœ¨ì´ 80%ë¥¼ ë„˜ì—ˆìŠµë‹ˆë‹¤.");
  if(STATE.timeLeft<=0){
    if(ratio<=0.2) return endGame(true,"ì œí•œ ì‹œê°„ ë‚´ ë°©ì–´ ì„±ê³µ!");
    return endGame(false,"ì‹œê°„ ì´ˆê³¼!");
  }
}
function endGame(win,msg){
  STATE.running=false;
  clearInterval(STATE.timerId); clearInterval(STATE.spreadId);
  alert((win? "ğŸ‰ ìŠ¹ë¦¬! " : "ğŸ˜µ ì‹¤íŒ¨! ") + msg + "  ì ìˆ˜: " + STATE.score);
  el('btn-start').disabled=false;
}

// í€´ì¦ˆ: ì‚°ì„± ê³ ë¥´ê¸°
function showQuiz(onDone){
  // ë³´ê¸°: ì‚°ì„± 1ê°œ + (ì—¼ê¸°ì„±/ì¤‘ì„±) 2ê°œ
  const acids = ITEMS.filter(x=>x.kind==='acid');
  const others = ITEMS.filter(x=>x.kind!=='acid');
  const answer = choice(acids);
  const picks = [answer, ...shuffle(others).slice(0,2)];
  shuffle(picks);
  const list = el('quizList'); list.innerHTML = "";
  picks.forEach(p=>{
    const node = document.createElement('div');
    node.className = "quiz-item";
    node.innerHTML = `<div class="big">${p.emoji}</div><div><b>${p.name}</b></div><div style="color:#64748b;font-size:12px">${p.tag}</div>`;
    node.addEventListener('click', ()=>{
      if(p.kind==='acid'){
        el('quizMsg').textContent = "ì •ë‹µ! ë³´ë„ˆìŠ¤ë¥¼ ì ìš©í•©ë‹ˆë‹¤.";
        onDone(true);
      } else {
        el('quizMsg').textContent = "ì•„ì‰¬ì›Œìš”! ì •ë‹µì€ ì‚°ì„± ë¬¼ì§ˆì…ë‹ˆë‹¤.";
        onDone(false);
      }
      hideQuiz();
    });
    list.appendChild(node);
  });
  el('quizSkip').onclick = ()=>{ hideQuiz(); onDone(false); };
  el('quizMsg').textContent = "ë³´ê¸° ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.";
  el('quizModal').style.display = "grid";
}
function hideQuiz(){ el('quizModal').style.display = "none"; }

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

// ì‹œì‘/ë¦¬ì…‹
function startGame(){
  showQuiz((won)=>{
    STATE.running=true; STATE.timeLeft=CFG.gameTime; STATE.score=0; STATE.combo=0;
    initBoard(); draw(); updateStats();
    if(won){
      STATE.score += CFG.quizScoreBonus;
      // ì´ˆê¸° ì˜¤ì—¼ 5ì¹¸ ì •í™”
      cleanseRandom(CFG.quizCleanse);
      updateStats(); draw();
    }
    STATE.startEpoch = Date.now();
    // íƒ€ì´ë¨¸
    clearInterval(STATE.timerId);
    const timeEl=el('time');
    STATE.timerId=setInterval(()=>{
      STATE.timeLeft=Math.max(0,STATE.timeLeft-0.1);
      timeEl.textContent=STATE.timeLeft.toFixed(1);
      if(STATE.timeLeft<=0){ clearInterval(STATE.timerId); checkWinLose(); }
    },100);
    // ì˜¤ì—¼(ê°€ë³€ ì£¼ê¸°)
    armSpreadTimer();
    el('btn-start').disabled=true;
  });
}
function cleanseRandom(n){
  const filled = STATE.board.map((v,i)=> ({v,i})).filter(o=>o.v!=='neutral').map(o=>o.i);
  shuffle(filled);
  for(let k=0;k<n && k<filled.length; k++){
    STATE.board[filled[k]] = 'neutral';
  }
}
function resetGame(){
  STATE.running=false; clearInterval(STATE.timerId); clearInterval(STATE.spreadId);
  STATE.timeLeft=CFG.gameTime; el('time').textContent=CFG.gameTime.toFixed(1);
  STATE.score=0; STATE.combo=0; STATE.selected=null; STATE.startEpoch=null;
  renderShelf(); drawBlank(); updateStats();
  el('btn-start').disabled=false;
  el('selName').textContent='-'; el('selTag').textContent='-';
}
function drawBlank(){
  STATE.board = new Array(CFG.rows*CFG.cols).fill('neutral');
  draw();
}

// ì´ë²¤íŠ¸
canvas.addEventListener('pointerdown', (e)=>{
  if(!STATE.running) return;
  const cell=getCellFromXY(e.clientX,e.clientY); if(!cell) return; applySelectedToCell(cell.c, cell.r);
});
el('btn-start').addEventListener('click', startGame);
el('btn-reset').addEventListener('click', resetGame);

function init(){
  renderShelf();
  drawBlank();
  fitCanvas();
  // ì¶”ì²œ: ë ˆëª¬ì¦™ ê¸°ë³¸ ì„ íƒ
  const firstAcid = ITEMS.findIndex(x=>x.kind==='acid');
  if(firstAcid>=0) selectItem(firstAcid);
}
init();

})();</script>
</body>
</html>
